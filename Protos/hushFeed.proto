syntax = "proto3";

import "google/protobuf/timestamp.proto";
import "hushReactions.proto";  // For ECPoint type

option csharp_namespace = "HushNetwork.proto";

package rpcHush;

service HushFeed {
  rpc HasPersonalFeed (HasPersonalFeedRequest) returns (HasPersonalFeedReply);
  rpc IsFeedInBlockchain (IsFeedInBlockchainRequest) returns (IsFeedInBlockchainReply);
  rpc GetFeedsForAddress (GetFeedForAddressRequest) returns (GetFeedForAddressReply);
  rpc GetFeedMessagesForAddress(GetFeedMessagesForAddressRequest) returns (GetFeedMessagesForAddressReply);
  
  /*
  rpc CreatePersonalFeed (CreatePersonalFeedRequest) returns (CreatePersonalFeedReply);
  rpc CreateChatFeed (CreateChatFeedRequest) returns (CreateChatFeedReply);
  rpc GetChatFeedParticipants (GetChatFeedParticipantsRequest) returns (GetChatFeedParticipantsReply);
  rpc SendMessage(SendMessageRequest) returns (SendMessageReply);
  */
}

message HasPersonalFeedRequest {
  string PublicPublicKey = 1;
}

message HasPersonalFeedReply {
  bool FeedAvailable = 1;
}

message IsFeedInBlockchainRequest {
  string FeedId = 1;
}

message IsFeedInBlockchainReply {
  bool FeedAvailable = 1;
}

message GetFeedForAddressRequest {
  string ProfilePublicKey = 1;
  int64 BlockIndex = 2;
}

message GetFeedForAddressReply {

  message FeedParticipant {
    string FeedId = 1;
    string ParticipantPublicAddress = 2;
    int32 ParticipantType = 3;
    string EncryptedFeedKey = 4;  // AES key encrypted with participant's RSA public key
  }

  message Feed {
    string FeedId = 1;
    string FeedTitle = 2;
    string FeedOWner = 3;
    int32 FeedType = 4;
    int64 BlockIndex = 5;

    repeated FeedParticipant FeedParticipants = 6;
  }

  repeated Feed Feeds = 1; 
}

message GetFeedMessagesForAddressRequest {
  string ProfilePublicKey = 1;
  int64 BlockIndex = 2;
  int64 LastReactionTallyVersion = 3;  // Only return tallies newer than this version
}

message GetFeedMessagesForAddressReply {

  message FeedMessage {
    string FeedId = 1;
    string FeedMessageId = 2;
    string MessageContent = 3;
    string IssuerPublicAddress = 4;
    string IssuerName = 5;
    google.protobuf.Timestamp TimeStamp = 6;
    int64 BlockIndex = 7;
    bytes AuthorCommitment = 8;  // Protocol Omega: Poseidon(author_secret)
  }

  // Reaction tally for a message (Protocol Omega)
  message MessageReactionTally {
    string MessageId = 1;              // Links to FeedMessage.FeedMessageId
    repeated ECPoint TallyC1 = 2;      // 6 aggregated C1 points
    repeated ECPoint TallyC2 = 3;      // 6 aggregated C2 points
    int64 TallyVersion = 4;            // Monotonic counter for cache invalidation
    int64 ReactionCount = 5;           // Total reactions (for quick "has reactions" check)
  }

  repeated FeedMessage Messages = 1;
  repeated MessageReactionTally ReactionTallies = 2;  // Tallies for messages with reactions
  int64 MaxReactionTallyVersion = 3;                  // For incremental sync
}




/*
message CreateFeedRequest {
  string FeedId = 1;
  int32 FeedType = 2;
  string Issuer = 3;
  string FeedParticipantPublicAddress = 4;
  string FeedPublicEncriptAddress = 5;
  string FeedPrivateEncriptAddress = 6;
  string Hash = 7;
  string Signature = 8;
}

message CreatePersonalFeedRequest {
  CreateFeedRequest PersonalFeed = 1;
}

message CreatePersonalFeedReply {
  bool Successfull = 1;
  string Message = 2;
}

message CreateChatFeedRequest {
  CreateFeedRequest ParticipantOne = 1;
  CreateFeedRequest ParticipantTwo = 2;
}

message CreateChatFeedReply {
  bool Successfull = 1;
  string Message = 2;
}

message GetChatFeedParticipantsRequest {
  string FeedId = 1;
}

message GetChatFeedParticipantsReply {
  message ChatParticipant {
    string PublicSigningAddress = 1;
    string PublicEncryptAddress = 2;
    int32 FeedParticipantType = 3;
  }

  repeated ChatParticipant ChatParticipants = 1;
}

message SendMessageRequest {
  string FeedMessageId = 1;
  string FeedId = 2;
  string Issuer = 3;
  string Message = 4;
  google.protobuf.Timestamp TimeStamp = 5;
  string Hash = 6;
  string Signature = 7;
}

message SendMessageReply {
  bool Successfull = 1;
  string Message = 2;
}
*/