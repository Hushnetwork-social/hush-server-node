using System.Text;

namespace HushNode.IntegrationTests.Infrastructure;

/// <summary>
/// Generates minimal valid PDF and video test files for E2E attachment tests.
/// Each file has a labeled name encoding sender, target, and file type
/// so test screenshots and verification can identify exactly which file
/// arrived at which recipient.
///
/// PDFs are generated as minimal valid PDF 1.0 with correct cross-reference offsets.
/// Videos use a real H.264 baseline MP4 (1s, 160x120, blue frame) generated by ffmpeg,
/// embedded as base64. The browser can decode this and extract frames via canvas,
/// so the E2E test exercises the real video-thumbnail path.
/// </summary>
internal static class TestFileGenerator
{
    /// <summary>
    /// Generates a labeled PDF document and returns the file name and PDF bytes.
    /// The PDF is minimal (single blank page) but valid enough for the attachment pipeline.
    /// pdfjs-dist in the browser may or may not render the first page, but the
    /// processAttachments pipeline handles errors gracefully.
    /// </summary>
    /// <param name="senderName">Display name of sender (e.g., "Alice").</param>
    /// <param name="targetName">Display name of target (e.g., "Bob").</param>
    /// <returns>Tuple of (fileName, pdfBytes).</returns>
    public static (string FileName, byte[] PdfBytes) GenerateTestPdf(string senderName, string targetName)
    {
        var fileName = $"Test-PDF-from-{senderName}-to-{targetName}.pdf";
        var pdfBytes = BuildMinimalPdf();
        return (fileName, pdfBytes);
    }

    /// <summary>
    /// Generates a labeled video file and returns the file name and bytes.
    /// The video is a real H.264 baseline MP4 (1s, 160x120, single blue frame)
    /// that browsers can decode and extract frames from via canvas.
    /// This exercises the real video-thumbnail path in E2E tests.
    /// </summary>
    /// <param name="senderName">Display name of sender (e.g., "Alice").</param>
    /// <param name="targetName">Display name of target (e.g., "Bob").</param>
    /// <returns>Tuple of (fileName, mp4Bytes).</returns>
    public static (string FileName, byte[] Mp4Bytes) GenerateTestVideo(string senderName, string targetName)
    {
        var fileName = $"Test-Video-from-{senderName}-to-{targetName}.mp4";
        var mp4Bytes = GetRealMp4Bytes();
        return (fileName, mp4Bytes);
    }

    /// <summary>
    /// Returns a tiny "executable" file for blocked file rejection testing.
    /// </summary>
    public static (string FileName, byte[] ExeBytes) GenerateBlockedExe()
    {
        var fileName = "program.exe";
        var exeBytes = Encoding.UTF8.GetBytes("MZ_FAKE_EXECUTABLE");
        return (fileName, exeBytes);
    }

    /// <summary>
    /// Builds a minimal valid PDF 1.0 document (single blank page, ~230 bytes).
    /// Cross-reference offsets are computed accurately.
    /// </summary>
    private static byte[] BuildMinimalPdf()
    {
        // Build the PDF body with known byte offsets
        var sb = new StringBuilder();
        sb.Append("%PDF-1.0\n");

        var obj1Offset = sb.Length;
        sb.Append("1 0 obj<</Type/Catalog/Pages 2 0 R>>endobj\n");

        var obj2Offset = sb.Length;
        sb.Append("2 0 obj<</Type/Pages/Kids[3 0 R]/Count 1>>endobj\n");

        var obj3Offset = sb.Length;
        sb.Append("3 0 obj<</Type/Page/MediaBox[0 0 612 792]/Parent 2 0 R>>endobj\n");

        var xrefOffset = sb.Length;
        sb.Append("xref\n0 4\n");
        sb.Append("0000000000 65535 f \n");
        sb.Append($"{obj1Offset:D10} 00000 n \n");
        sb.Append($"{obj2Offset:D10} 00000 n \n");
        sb.Append($"{obj3Offset:D10} 00000 n \n");
        sb.Append("trailer<</Root 1 0 R/Size 4>>\n");
        sb.Append($"startxref\n{xrefOffset}\n%%EOF");

        return Encoding.ASCII.GetBytes(sb.ToString());
    }

    /// <summary>
    /// Real H.264 baseline MP4 video (1s, 160x120, single blue frame, ~1.5KB).
    /// Generated with: ffmpeg -f lavfi -i "color=c=blue:s=160x120:d=1:r=1" -c:v libx264 -profile:v baseline -level 3.0 -pix_fmt yuv420p -t 1
    /// Browsers can decode this and extract frames via canvas, exercising the real video-thumbnail path.
    /// </summary>
    private const string RealMp4Base64 =
        "AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAtFtZGF0AAAC" +
        "cAYF//9s3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE2NSByMzIyMyAwNDgwY2Iw" +
        "IC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAyNSAtIGh0" +
        "dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTAg" +
        "cmVmPTMgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MToweDExMSBtZT1oZXggc3VibWU9" +
        "NyBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNo" +
        "cm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MCBjcW09MCBkZWFkem9uZT0yMSwxMSBm" +
        "YXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTQgbG9va2FoZWFk" +
        "X3RocmVhZHM9MSBzbGljZWRfdGhyZWFkcz0wIG5yPTAgZGVjaW1hdGU9MSBpbnRlcmxh" +
        "Y2VkPTAgYmx1cmF5X2NvbXBhdD0wIGNvbnN0cmFpbmVkX2ludHJhPTAgYmZyYW1lcz0w" +
        "IHdlaWdodHA9MCBrZXlpbnQ9MjUwIGtleWludF9taW49MSBzY2VuZWN1dD00MCBpbnRy" +
        "YV9yZWZyZXNoPTAgcmNfbG9va2FoZWFkPTQwIHJjPWNyZiBtYnRyZWU9MSBjcmY9MjMu" +
        "MCBxY29tcD0wLjYwIHFwbWluPTAgcXBtYXg9NjkgcXBzdGVwPTQgaXBfcmF0aW89MS40" +
        "MCBhcT0xOjEuMDAAgAAAAFFliIQFfEYoAA6gxwABsGjgACNDJycnJycnJycnXXXXXXXX" +
        "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXgAAAMQbW9v" +
        "dgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAAA+gAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAA" +
        "AAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAA" +
        "Ajt0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAA+gAAAAAAAAAAAAAAAAAAAAA" +
        "AAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAKAAAAB4AAAAAAAkZWR0cwAA" +
        "ABxlbHN0AAAAAAAAAAEAAAPoAAAAAAABAAAAAAGzbWRpYQAAACBtZGhkAAAAAAAAAAAAAAAA" +
        "AABAAAAAQABVxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRs" +
        "ZXIAAAABXm1pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAA" +
        "AQAAAAx1cmwgAAAAAQAAAR5zdGJsAAAAunN0c2QAAAAAAAAAAQAAAKphdmMxAAAAAAAAAAAA" +
        "AQAAAAAAAAAAAAAAAAAAAAAAKAAeABIAAAASAAAAAAAAAABFTGF2YzYyLjIyLjEwMSBsaWJ4" +
        "MjY0AAAAAAAAAAAAAAAY//8AAAAwYXZjQwFCwB7/4QAYZ0LAHtkChH5cBEAAAAMAEAAAAwCD" +
        "xYuSAQAFaMuDyyAAAAARcGFzcAAAAAEAAAABAAAAFGJ0cnQAAAAAAAAWSAAAAAAAAAAYc3R0" +
        "cwAAAAAAAAABAAAAAQAAQAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oA" +
        "AAAAAAACSQAAAAEAAAAUc3RjbwAAAAAAAAABAAAAMAAAAGF1ZHRhAAAAWW1ldGEAAAAAACFo" +
        "ZGxyAAAAAAAAAABtZGlyYXBwbAAAAAAAAAAAAAAAACxpbHN0AAAAJKl0b28AAAAcZGF0YQAA" +
        "AAEAAAAATGF2ZjYyLjYuMTAz";

    /// <summary>
    /// Returns the real MP4 video bytes decoded from the embedded base64 constant.
    /// </summary>
    private static byte[] GetRealMp4Bytes() => Convert.FromBase64String(RealMp4Base64);
}
