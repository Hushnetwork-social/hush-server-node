# docker-compose.e2e.yml
# HushWebClient container for E2E integration tests
#
# IMPORTANT: This uses a PRE-BUILT image to avoid slow rebuilds during tests.
# The gRPC-Web port is fixed at 14666 (HushServerNodeCore.E2EGrpcWebPort).
#
# First-time setup (run once, or after web client code changes):
#   docker compose -f docker-compose.e2e.yml build
#
# Running tests (uses cached image, no rebuild):
#   docker compose -f docker-compose.e2e.yml up -d --wait
#   docker compose -f docker-compose.e2e.yml down --remove-orphans

services:
  hush-web-client:
    image: hush-web-client-e2e:latest
    build:
      # Build context is repo root (2 levels up from this file)
      context: ../..
      dockerfile: hush-web-client/Dockerfile
      args:
        # Fixed gRPC-Web port - must match HushServerNodeCore.E2EGrpcWebPort (14666)
        - NEXT_PUBLIC_GRPC_URL=http://host.docker.internal:14666
        - NEXT_PUBLIC_DEBUG_LOGGING=true
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    extra_hosts:
      # Enable container to reach host machine
      - "host.docker.internal:host-gateway"
