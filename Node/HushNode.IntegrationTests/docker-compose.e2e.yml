# docker-compose.e2e.yml
# HushWebClient container for E2E integration tests
#
# IMPORTANT: This uses a PRE-BUILT image to avoid slow rebuilds during tests.
# The gRPC-Web port is fixed at 14666 (HushServerNodeCore.E2EGrpcWebPort).
#
# First-time setup (run once, or after web client code changes):
#   docker compose -f docker-compose.e2e.yml build
#
# Running tests (uses cached image, no rebuild):
#   docker compose -f docker-compose.e2e.yml up -d --wait
#   docker compose -f docker-compose.e2e.yml down --remove-orphans

services:
  hush-web-client:
    image: hush-web-client-e2e:latest
    build:
      # Build context is repo root (2 levels up from this file)
      context: ../..
      dockerfile: hush-web-client/Dockerfile
      args:
        # Fixed gRPC-Web port - must match HushServerNodeCore.E2EGrpcWebPort (14666)
        - NEXT_PUBLIC_GRPC_URL=http://host.docker.internal:14666
        - NEXT_PUBLIC_DEBUG_LOGGING=true
        # Disable auto-sync for E2E tests - sync is triggered manually via window.__e2e_triggerSync()
        - NEXT_PUBLIC_SYNC_INTERVAL_MS=999999
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      # Server-side gRPC URL for API routes (must match build-time NEXT_PUBLIC_GRPC_URL)
      - GRPC_SERVER_URL=http://host.docker.internal:14666
    healthcheck:
      # Use node for health check since Next.js standalone may not have wget/curl
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 3s
      timeout: 10s
      retries: 30
      start_period: 10s
    extra_hosts:
      # Enable container to reach host machine
      - "host.docker.internal:host-gateway"
