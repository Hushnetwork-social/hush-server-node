syntax = "proto3";

import "google/protobuf/timestamp.proto";
import "hushReactions.proto";  // For ECPoint type

option csharp_namespace = "HushNetwork.proto";

package rpcHush;

service HushFeed {
  rpc HasPersonalFeed (HasPersonalFeedRequest) returns (HasPersonalFeedReply);
  rpc IsFeedInBlockchain (IsFeedInBlockchainRequest) returns (IsFeedInBlockchainReply);
  rpc GetFeedsForAddress (GetFeedForAddressRequest) returns (GetFeedForAddressReply);
  rpc GetFeedMessagesForAddress(GetFeedMessagesForAddressRequest) returns (GetFeedMessagesForAddressReply);

  // Group Feed Query Operations
  rpc GetGroupMembers (GetGroupMembersRequest) returns (GetGroupMembersResponse);
  rpc GetKeyGenerations (GetKeyGenerationsRequest) returns (GetKeyGenerationsResponse);
  rpc GetGroupFeed (GetGroupFeedRequest) returns (GetGroupFeedResponse);
  rpc GetGroupFeedByInviteCode (GetGroupFeedByInviteCodeRequest) returns (GetGroupFeedByInviteCodeResponse);
  rpc SearchPublicGroups (SearchPublicGroupsRequest) returns (SearchPublicGroupsResponse);

  // Group Feed Creation & Membership Operations
  rpc CreateGroupFeed (NewGroupFeedRequest) returns (NewGroupFeedResponse);
  rpc JoinGroupFeed (JoinGroupFeedRequest) returns (JoinGroupFeedResponse);
  rpc LeaveGroupFeed (LeaveGroupFeedRequest) returns (LeaveGroupFeedResponse);

  // Group Feed Admin Operations
  rpc AddMemberToGroupFeed (AddMemberToGroupFeedRequest) returns (AddMemberToGroupFeedResponse);
  rpc BlockMember (BlockMemberRequest) returns (BlockMemberResponse);
  rpc UnblockMember (UnblockMemberRequest) returns (UnblockMemberResponse);
  rpc BanFromGroupFeed (BanFromGroupFeedRequest) returns (BanFromGroupFeedResponse);
  rpc UnbanFromGroupFeed (UnbanFromGroupFeedRequest) returns (UnbanFromGroupFeedResponse);
  rpc PromoteToAdmin (PromoteToAdminRequest) returns (PromoteToAdminResponse);
  rpc UpdateGroupFeedTitle (UpdateGroupFeedTitleRequest) returns (UpdateGroupFeedTitleResponse);
  rpc UpdateGroupFeedDescription (UpdateGroupFeedDescriptionRequest) returns (UpdateGroupFeedDescriptionResponse);
  rpc UpdateGroupFeedSettings (UpdateGroupFeedSettingsRequest) returns (UpdateGroupFeedSettingsResponse);
  rpc DeleteGroupFeed (DeleteGroupFeedRequest) returns (DeleteGroupFeedResponse);

  /*
  rpc CreatePersonalFeed (CreatePersonalFeedRequest) returns (CreatePersonalFeedReply);
  rpc CreateChatFeed (CreateChatFeedRequest) returns (CreateChatFeedReply);
  rpc GetChatFeedParticipants (GetChatFeedParticipantsRequest) returns (GetChatFeedParticipantsReply);
  rpc SendMessage(SendMessageRequest) returns (SendMessageReply);
  */
}

message HasPersonalFeedRequest {
  string PublicPublicKey = 1;
}

message HasPersonalFeedReply {
  bool FeedAvailable = 1;
}

message IsFeedInBlockchainRequest {
  string FeedId = 1;
}

message IsFeedInBlockchainReply {
  bool FeedAvailable = 1;
}

message GetFeedForAddressRequest {
  string ProfilePublicKey = 1;
  int64 BlockIndex = 2;
}

message GetFeedForAddressReply {

  message FeedParticipant {
    string FeedId = 1;
    string ParticipantPublicAddress = 2;
    int32 ParticipantType = 3;
    string EncryptedFeedKey = 4;  // AES key encrypted with participant's RSA public key
  }

  message Feed {
    string FeedId = 1;
    string FeedTitle = 2;
    string FeedOWner = 3;
    int32 FeedType = 4;
    int64 BlockIndex = 5;

    repeated FeedParticipant FeedParticipants = 6;
  }

  repeated Feed Feeds = 1; 
}

message GetFeedMessagesForAddressRequest {
  string ProfilePublicKey = 1;
  int64 BlockIndex = 2;
  int64 LastReactionTallyVersion = 3;  // Only return tallies newer than this version
}

message GetFeedMessagesForAddressReply {

  message FeedMessage {
    string FeedId = 1;
    string FeedMessageId = 2;
    string MessageContent = 3;
    string IssuerPublicAddress = 4;
    string IssuerName = 5;
    google.protobuf.Timestamp TimeStamp = 6;
    int64 BlockIndex = 7;
    bytes AuthorCommitment = 8;  // Protocol Omega: Poseidon(author_secret)
    optional string ReplyToMessageId = 9;  // Reply to Message: parent message reference
    optional int32 KeyGeneration = 10;  // Group Feeds: Key generation used to encrypt this message
  }

  // Reaction tally for a message (Protocol Omega)
  message MessageReactionTally {
    string MessageId = 1;              // Links to FeedMessage.FeedMessageId
    repeated ECPoint TallyC1 = 2;      // 6 aggregated C1 points
    repeated ECPoint TallyC2 = 3;      // 6 aggregated C2 points
    int64 TallyVersion = 4;            // Monotonic counter for cache invalidation
    int64 ReactionCount = 5;           // Total reactions (for quick "has reactions" check)
  }

  repeated FeedMessage Messages = 1;
  repeated MessageReactionTally ReactionTallies = 2;  // Tallies for messages with reactions
  int64 MaxReactionTallyVersion = 3;                  // For incremental sync
}

// =============================================================================
// Group Feed Messages (FEAT-006)
// =============================================================================

// --- Shared Types for Group Feed ---

// Represents a participant in a Group Feed with their encrypted key
message GroupFeedParticipantProto {
  string FeedId = 1;
  string ParticipantPublicAddress = 2;
  int32 ParticipantType = 3;  // Maps to ParticipantType enum
  string EncryptedFeedKey = 4;  // AES key encrypted with participant's public encrypt key
  int32 KeyGeneration = 5;  // Key generation number for key rotation tracking
}

// Represents an encrypted key for a specific member during key rotation
message GroupFeedEncryptedKeyProto {
  string MemberPublicAddress = 1;
  string EncryptedAesKey = 2;  // New AES key encrypted with member's public encrypt key
}

// Represents a member in a Group Feed for query responses
message GroupFeedMemberProto {
  string PublicAddress = 1;
  int32 ParticipantType = 2;  // Maps to ParticipantType enum
  int64 JoinedAtBlock = 3;
  optional int64 LeftAtBlock = 4;  // Set if member has left or been banned
  optional string DisplayName = 5;  // Display name at time of query
}

// --- Task 3.1: Group Feed Creation ---

message NewGroupFeedRequest {
  string FeedId = 1;
  string Title = 2;
  string Description = 3;
  bool IsPublic = 4;
  repeated GroupFeedParticipantProto Participants = 5;
}

message NewGroupFeedResponse {
  bool Success = 1;
  string Message = 2;
}

// --- Task 3.2: Membership Change ---

message JoinGroupFeedRequest {
  string FeedId = 1;
  string JoiningUserPublicAddress = 2;
  optional string InvitationSignature = 3;  // Required for private groups
  optional string JoiningUserPublicEncryptKey = 4;  // User's public encrypt key for key rotation (avoids identity lookup timing issue)
}

message JoinGroupFeedResponse {
  bool Success = 1;
  string Message = 2;
}

message LeaveGroupFeedRequest {
  string FeedId = 1;
  string LeavingUserPublicAddress = 2;
}

message LeaveGroupFeedResponse {
  bool Success = 1;
  string Message = 2;
}

message AddMemberToGroupFeedRequest {
  string FeedId = 1;
  string AdminPublicAddress = 2;
  string NewMemberPublicAddress = 3;
  string NewMemberPublicEncryptKey = 4;
}

message AddMemberToGroupFeedResponse {
  bool Success = 1;
  string Message = 2;
}

// --- Task 3.3: Admin Controls ---

message BlockMemberRequest {
  string FeedId = 1;
  string AdminPublicAddress = 2;
  string BlockedUserPublicAddress = 3;
  optional string Reason = 4;
}

message BlockMemberResponse {
  bool Success = 1;
  string Message = 2;
}

message UnblockMemberRequest {
  string FeedId = 1;
  string AdminPublicAddress = 2;
  string UnblockedUserPublicAddress = 3;
}

message UnblockMemberResponse {
  bool Success = 1;
  string Message = 2;
}

message BanFromGroupFeedRequest {
  string FeedId = 1;
  string AdminPublicAddress = 2;
  string BannedUserPublicAddress = 3;
  optional string Reason = 4;
}

message BanFromGroupFeedResponse {
  bool Success = 1;
  string Message = 2;
}

message UnbanFromGroupFeedRequest {
  string FeedId = 1;
  string AdminPublicAddress = 2;
  string UnbannedUserPublicAddress = 3;
}

message UnbanFromGroupFeedResponse {
  bool Success = 1;
  string Message = 2;
}

message PromoteToAdminRequest {
  string FeedId = 1;
  string AdminPublicAddress = 2;
  string MemberPublicAddress = 3;
}

message PromoteToAdminResponse {
  bool Success = 1;
  string Message = 2;
}

message UpdateGroupFeedTitleRequest {
  string FeedId = 1;
  string AdminPublicAddress = 2;
  string NewTitle = 3;
}

message UpdateGroupFeedTitleResponse {
  bool Success = 1;
  string Message = 2;
}

message UpdateGroupFeedDescriptionRequest {
  string FeedId = 1;
  string AdminPublicAddress = 2;
  string NewDescription = 3;
}

message UpdateGroupFeedDescriptionResponse {
  bool Success = 1;
  string Message = 2;
}

message UpdateGroupFeedSettingsRequest {
  string FeedId = 1;
  string AdminPublicAddress = 2;
  optional string NewTitle = 3;
  optional string NewDescription = 4;
  optional bool IsPublic = 5;
}

message UpdateGroupFeedSettingsResponse {
  bool Success = 1;
  string Message = 2;
}

message DeleteGroupFeedRequest {
  string FeedId = 1;
  string AdminPublicAddress = 2;
}

message DeleteGroupFeedResponse {
  bool Success = 1;
  string Message = 2;
}

// --- Task 3.4: Key Rotation and Messaging ---

message GroupFeedKeyRotationRequest {
  string FeedId = 1;
  int32 NewKeyGeneration = 2;
  int32 PreviousKeyGeneration = 3;
  int64 ValidFromBlock = 4;
  repeated GroupFeedEncryptedKeyProto EncryptedKeys = 5;
  int32 RotationTrigger = 6;  // Maps to RotationTrigger enum
}

message GroupFeedKeyRotationResponse {
  bool Success = 1;
  string Message = 2;
}

message NewGroupFeedMessageRequest {
  string MessageId = 1;
  string FeedId = 2;
  string EncryptedContent = 3;
  int32 KeyGeneration = 4;
  optional string ReplyToMessageId = 5;
  optional bytes AuthorCommitment = 6;  // Protocol Omega: Poseidon(author_secret)
}

message NewGroupFeedMessageResponse {
  bool Success = 1;
  string Message = 2;
}

// --- Task 3.5: Query Messages ---

message GetGroupFeedRequest {
  string FeedId = 1;
}

message GetGroupFeedResponse {
  bool Success = 1;
  string Message = 2;
  string FeedId = 3;
  string Title = 4;
  string Description = 5;
  bool IsPublic = 6;
  int32 MemberCount = 7;
  int32 CurrentKeyGeneration = 8;
  optional string InviteCode = 9;  // Unique invite code for public groups
}

// --- Get Group Feed by Invite Code ---

message GetGroupFeedByInviteCodeRequest {
  string InviteCode = 1;  // 8-char alphanumeric uppercase code
}

message GetGroupFeedByInviteCodeResponse {
  bool Success = 1;
  string Message = 2;
  string FeedId = 3;
  string Title = 4;
  string Description = 5;
  bool IsPublic = 6;
  int32 MemberCount = 7;
}

message GetGroupMembersRequest {
  string FeedId = 1;
}

message GetGroupMembersResponse {
  repeated GroupFeedMemberProto Members = 1;
}

// --- Get Key Generations for User ---

message GetKeyGenerationsRequest {
  string FeedId = 1;
  string UserPublicAddress = 2;
}

message KeyGenerationProto {
  int32 KeyGeneration = 1;
  string EncryptedKey = 2;  // AES key encrypted for this user
  int64 ValidFromBlock = 3;
  optional int64 ValidToBlock = 4;  // Null if still active
}

message GetKeyGenerationsResponse {
  repeated KeyGenerationProto KeyGenerations = 1;
}

// --- Search Public Groups ---

message SearchPublicGroupsRequest {
  string SearchQuery = 1;  // Partial title/description to search for
  int32 MaxResults = 2;    // Maximum number of results to return (default 20)
}

message PublicGroupInfoProto {
  string FeedId = 1;
  string Title = 2;
  string Description = 3;
  int32 MemberCount = 4;
  int64 CreatedAtBlock = 5;
}

message SearchPublicGroupsResponse {
  bool Success = 1;
  string Message = 2;
  repeated PublicGroupInfoProto Groups = 3;
}

/*
message CreateFeedRequest {
  string FeedId = 1;
  int32 FeedType = 2;
  string Issuer = 3;
  string FeedParticipantPublicAddress = 4;
  string FeedPublicEncriptAddress = 5;
  string FeedPrivateEncriptAddress = 6;
  string Hash = 7;
  string Signature = 8;
}

message CreatePersonalFeedRequest {
  CreateFeedRequest PersonalFeed = 1;
}

message CreatePersonalFeedReply {
  bool Successfull = 1;
  string Message = 2;
}

message CreateChatFeedRequest {
  CreateFeedRequest ParticipantOne = 1;
  CreateFeedRequest ParticipantTwo = 2;
}

message CreateChatFeedReply {
  bool Successfull = 1;
  string Message = 2;
}

message GetChatFeedParticipantsRequest {
  string FeedId = 1;
}

message GetChatFeedParticipantsReply {
  message ChatParticipant {
    string PublicSigningAddress = 1;
    string PublicEncryptAddress = 2;
    int32 FeedParticipantType = 3;
  }

  repeated ChatParticipant ChatParticipants = 1;
}

message SendMessageRequest {
  string FeedMessageId = 1;
  string FeedId = 2;
  string Issuer = 3;
  string Message = 4;
  google.protobuf.Timestamp TimeStamp = 5;
  string Hash = 6;
  string Signature = 7;
}

message SendMessageReply {
  bool Successfull = 1;
  string Message = 2;
}
*/