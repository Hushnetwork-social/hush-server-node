using FluentAssertions;
using SkiaSharp;
using Xunit;

namespace HushNode.IntegrationTests.Infrastructure;

/// <summary>
/// Unit tests for TestImageGenerator - verifies labeled test images are valid PNGs
/// with correct file naming and different colors per index.
/// </summary>
public class TestImageGeneratorTests
{
    [Fact]
    public void GenerateTestAttachment_ShouldReturnCorrectFileName()
    {
        // Act
        var (fileName, _) = TestImageGenerator.GenerateTestAttachment(1, "Alice", "Bob");

        // Assert
        fileName.Should().Be("Image-1-from-Alice-to-Bob.png");
    }

    [Fact]
    public void GenerateTestAttachment_ShouldReturnDifferentFileNamePerIndex()
    {
        // Act
        var (fileName1, _) = TestImageGenerator.GenerateTestAttachment(1, "Alice", "Bob");
        var (fileName2, _) = TestImageGenerator.GenerateTestAttachment(2, "Alice", "Bob");

        // Assert
        fileName1.Should().NotBe(fileName2);
        fileName2.Should().Be("Image-2-from-Alice-to-Bob.png");
    }

    [Fact]
    public void GenerateTestAttachment_ShouldReturnValidPng()
    {
        // Act
        var (_, pngBytes) = TestImageGenerator.GenerateTestAttachment(1, "Alice", "Bob");

        // Assert - should be decodable as a valid image
        using var bitmap = SKBitmap.Decode(pngBytes);
        bitmap.Should().NotBeNull("Generated bytes should be a valid PNG");
        bitmap!.Width.Should().Be(400);
        bitmap.Height.Should().Be(200);
    }

    [Fact]
    public void GenerateTestAttachment_ShouldProduceDifferentImagesPerIndex()
    {
        // Act
        var (_, bytes1) = TestImageGenerator.GenerateTestAttachment(1, "Alice", "Bob");
        var (_, bytes2) = TestImageGenerator.GenerateTestAttachment(2, "Alice", "Bob");

        // Assert - different index = different color = different bytes
        bytes1.Should().NotBeEquivalentTo(bytes2,
            "Different image indices should produce different colored images");
    }

    [Fact]
    public void GenerateTestAttachment_ShouldSupportGroupTargetNames()
    {
        // Act
        var (fileName, pngBytes) = TestImageGenerator.GenerateTestAttachment(3, "Alice", "Open Forum");

        // Assert
        fileName.Should().Be("Image-3-from-Alice-to-Open Forum.png");
        pngBytes.Should().NotBeEmpty();

        // Should still be a valid PNG
        using var bitmap = SKBitmap.Decode(pngBytes);
        bitmap.Should().NotBeNull();
    }

    [Fact]
    public void GenerateTestAttachment_ShouldProduceReasonablySizedBytes()
    {
        // Act
        var (_, pngBytes) = TestImageGenerator.GenerateTestAttachment(1, "Alice", "Bob");

        // Assert - 400x200 PNG with simple graphics should be under 50KB
        pngBytes.Length.Should().BeGreaterThan(100, "Should not be trivially small");
        pngBytes.Length.Should().BeLessThan(50_000, "Simple labeled PNG should be under 50KB");
    }
}
